#!/bin/bash

#############################################################################
# vucem-angular - Generador Angular VUCEM Ultra Moderno
# 
# Descripci√≥n: Script principal para crear aplicaciones Angular VUCEM
#              con arquitectura limpia y stack 2025
#
# Uso: vucem-angular <nombre> <area> [descripci√≥n]
# 
# Autor: VUCEM Team
# Versi√≥n: 1.0.0
# Fecha: 2025-08-22
#############################################################################

set -euo pipefail
IFS=$'\n\t'

# ===========================================================================
# CONFIGURACI√ìN
# ===========================================================================

readonly SCRIPT_VERSION="1.0.0"
readonly GITHUB_RAW="https://raw.githubusercontent.com/osvalois-ultrasist/plantilla-vucem-componente-angular/main"

# Colores para m√°xima legibilidad
if [[ -t 1 ]]; then
    readonly B='\033[1m'    # Bold
    readonly R='\033[0;31m' # Red
    readonly G='\033[0;32m' # Green
    readonly Y='\033[0;33m' # Yellow
    readonly C='\033[0;36m' # Cyan
    readonly P='\033[0;35m' # Purple
    readonly NC='\033[0m'   # No Color
else
    readonly B='' R='' G='' Y='' C='' P='' NC=''
fi

# ===========================================================================
# FUNCIONES
# ===========================================================================

msg() { echo -e "${C}‚ñ∏${NC} $*"; }
ok() { echo -e "${G}‚úì${NC} $*"; }
warn() { echo -e "${Y}‚ö†${NC} $*"; }
err() { echo -e "${R}‚úó${NC} $*" >&2; }

help() {
    echo -e "${B}${P}VUCEM Angular${NC} - Generador de Aplicaciones Modernas"
    echo
    echo -e "${B}Stack Angular 2025:${NC}"
    echo "  ‚Ä¢ Angular 20.0.0 + Signal-based Reactivity"
    echo "  ‚Ä¢ TypeScript 5.7 + Strict Mode"
    echo "  ‚Ä¢ Angular Material 17 + Design System"
    echo "  ‚Ä¢ NgRx 17 + Signals Integration"
    echo "  ‚Ä¢ Clean Architecture + DDD"
    echo
    echo -e "${B}USO:${NC}"
    echo "  vucem-angular <nombre> <area> [\"descripci√≥n\"]"
    echo
    echo -e "${B}EJEMPLOS:${NC}"
    echo "  vucem-angular mi-app usuarios"
    echo "  vucem-angular sistema-aduanas aduanas \"Sistema de gesti√≥n\""
    echo
    echo -e "${B}CARACTER√çSTICAS:${NC}"
    echo "  ‚ú® Arquitectura Clean de 4 capas"
    echo "  üöÄ Signals + Standalone Components"
    echo "  üé® Material Design 3 + Accesibilidad WCAG"
    echo "  üîê JWT + Seguridad Enterprise"
    echo "  üì± PWA + SSR Ready"
    echo "  üß™ Vitest + Cypress Testing"
    echo
    echo -e "${B}REQUISITOS:${NC}"
    echo "  Node.js 18+, npm 9+, Angular CLI 20+"
    echo
    echo -e "${B}M√ÅS INFO:${NC}"
    echo "  curl -s ${GITHUB_RAW}/setup-angular | bash  # Setup sistema"
    echo "  curl -s ${GITHUB_RAW}/check-angular | bash  # Validar proyecto"
    echo
}

# Validaci√≥n ultra r√°pida
valid() {
    local name="$1"
    [[ ${#name} -ge 3 ]] && [[ ${#name} -le 50 ]] && [[ "$name" =~ ^[a-z][a-z0-9-]*$ ]] && [[ "$name" != *"--"* ]]
}

# ===========================================================================
# PROGRAMA PRINCIPAL
# ===========================================================================

main() {
    # Mostrar ayuda si no hay argumentos suficientes
    if [[ $# -lt 2 ]]; then
        help
        exit 1
    fi
    
    local name="$1"
    local area="$2"
    local desc="${3:-Aplicaci√≥n Angular VUCEM para $area}"
    
    # Validaci√≥n r√°pida
    if ! valid "$name" || ! valid "$area"; then
        err "Nombre/√°rea debe: 3-50 chars, solo min√∫sculas y guiones, empezar con letra"
        exit 1
    fi
    
    msg "Creando aplicaci√≥n Angular: vucem-${name}"
    
    # Verificar Node.js y npm
    if ! command -v node &> /dev/null; then
        err "Node.js requerido. Instalar desde: https://nodejs.org/"
        exit 1
    fi
    
    if ! command -v npm &> /dev/null; then
        err "npm requerido. Viene con Node.js"
        exit 1
    fi
    
    # Verificar versiones m√≠nimas
    local node_version=$(node --version | sed 's/v//' | cut -d'.' -f1)
    if [[ $node_version -lt 18 ]]; then
        err "Node.js 18+ requerido. Versi√≥n actual: v$node_version"
        exit 1
    fi
    
    # Descargar y ejecutar generador remoto Angular
    msg "Descargando generador Angular desde GitHub..."
    
    if curl -sSL "${GITHUB_RAW}/crear-angular-remoto.sh" | bash -s "$name" "$area" "$desc"; then
        echo
        ok "¬°Aplicaci√≥n Angular creada!"
        echo
        echo -e "${B}${P}Pr√≥ximos pasos:${NC}"
        echo "  cd vucem-${name}"
        echo "  npm install"
        echo "  ng serve"
        echo
        echo -e "${B}URLs de desarrollo:${NC}"
        echo "  http://localhost:4200         # Aplicaci√≥n"
        echo "  http://localhost:4200/docs    # Documentaci√≥n"
        echo
        echo -e "${B}Comandos √∫tiles:${NC}"
        echo "  npm run build:prod    # Build producci√≥n"
        echo "  npm run test          # Tests unitarios"
        echo "  npm run e2e           # Tests E2E"
        echo "  npm run lint          # Linting"
        echo "  npm run a11y          # Accesibilidad"
        echo
        echo -e "${P}¬°Angular 2025 listo para desarrollo! üöÄ${NC}"
    else
        err "Error al crear aplicaci√≥n Angular"
        exit 1
    fi
}

# Ejecutar
main "$@"